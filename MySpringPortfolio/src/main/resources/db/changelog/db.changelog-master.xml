<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
  <!-- Add your changelog elements here -->

  <!-- Users table -->
  <changeSet id="create-users-table" author="your_name">
    <createTable tableName="users">
        <column name="id" type="int" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="email" type="varchar(255)"/>
        <column name="password" type="varchar(255)"/>
        <column name="first_name" type="varchar(255)"/>
        <column name="last_name" type="varchar(255)"/>
        <column name="date_of_birth" type="date"/>
        <column name="phone_number" type="varchar(20)"/>
        <column name="address" type="varchar(255)"/>
        <column name="account_type" type="varchar(20)"/>
        <column name="account_status" type="varchar(20)"/>
        <column name="created_at" type="timestamp"/>
    </createTable>
    </changeSet>

    <!-- Seed data for users table -->
    <changeSet id="insert-seed-data" author="your_name">
        <insert tableName="users">
            <column name="email" value="user1@example.com"/>
            <column name="password" value="password1"/>
            <column name="first_name" value="User"/>
            <column name="last_name" value="One"/>
            <column name="date_of_birth" value="1980-01-01"/>
            <column name="phone_number" value="123-456-7890"/>
            <column name="address" value="123 Main St."/>
            <column name="account_type" value="individual"/>
            <column name="account_status" value="active"/>
            <column name="created_at" value="${now}"/>
        </insert>
    </changeSet>

    <!-- User's porfolio table template(1 for each user) -->
    <changeSet id="create-portfolio-template" author="liquibase">
        <template>
        <![CDATA[
            CREATE TABLE Portfolio_{UserID} (
            ID INTEGER PRIMARY KEY,
            UserID INTEGER NOT NULL,
            InvestmentName VARCHAR(255) NOT NULL,
            InvestmentType VARCHAR(255) NOT NULL,
            InvestmentAmount NUMERIC NOT NULL,
            InvestmentCostBasis NUMERIC NOT NULL,
            InvestmentDate TIMESTAMP NOT NULL,
            FOREIGN KEY (UserID) REFERENCES Users(ID)
            );
        ]]>
        </template>
    </changeSet>

    <preconditions onFail="MARK_RAN">
        <not>
            <tableExists tableName="Portfolio_1" />
        </not>
    </preconditions>

    <createTable tableName="Portfolio_1">
        <column name="ID" type="INTEGER" autoIncrement="true" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="UserID" type="INTEGER" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="InvestmentName" type="VARCHAR(255)" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="InvestmentType" type="VARCHAR(255)" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="InvestmentAmount" type="NUMERIC" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="InvestmentCostBasis" type="NUMERIC" primaryKey="true">
            <constraints nullable="false"/>
        </column>
        <column name="InvestmentDate" type="TIMESTAMP" primaryKey="true">
            <constraints nullable="false"/>
        </column>
    </createTable>

    <addForeignKeyConstraint baseColumnNames="UserID"
                             baseTableName="Portfolio_1"
                             constraintName="fk_userid"
                             referencedColumnNames="ID"
                             referencedTableName="Users"
                             />

    <!-- Generic update template -->
    <changeSet id="update-template" author="liquibase">
        <template>
            <![CDATA[
            UPDATE {tableName}
            SET {field} = {value}
            WHERE {whereField} = {whereValue}
            ]]>
        </template>
    </changeSet>

    <!-- Generic Insert template -->
    <changeSet id="insert-template" author="liquibase">
        <template>
            <![CDATA[
            INSERT INTO {tableName} ({fields})
            VALUES ({values})
            ]]>
        </template>
    </changeSet>

    <!-- Generic Delete template -->
    <changeSet id="delete-template" author="liquibase">
        <template>
            <![CDATA[
            DELETE FROM {tableName}
            WHERE {whereField} = {whereValue}
            ]]>
        </template>
    </changeSet>


</databaseChangeLog>

